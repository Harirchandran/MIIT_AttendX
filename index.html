<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Responsive meta tag -->
  <title>Students Attendance Taker</title>
  <!-- Include Bootstrap CSS for a responsive UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { margin: 20px; }
    .student-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }
    .status-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .status-btn.present { background-color: #90EE90; }
    .status-btn.absent { background-color: #FFB6C1; }
    /* Attendance Report styles */
    .status-box {
      display: inline-block;
      width: 140px;
      padding: 10px;
      margin: 5px;
      text-align: center;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
    }
    .status-green { background-color: #28a745; }
    .status-red { background-color: #dc3545; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h1 class="mb-4 text-center">Students Attendance Taker</h1>
    
    <!-- Attendance Session Details -->
    <div class="card mb-4">
      <div class="card-header">Attendance Session Details</div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-3 col-12 mb-2">
            <label for="course" class="form-label">Course</label>
            <select id="course" class="form-select">
              <option value="MCA">MCA</option>
              <option value="MBA">MBA</option>
            </select>
          </div>
          <div class="col-md-3 col-12 mb-2">
            <label for="semester" class="form-label">Semester</label>
            <select id="semester" class="form-select">
              <option value="1">Sem 1</option>
              <option value="2">Sem 2</option>
              <option value="3">Sem 3</option>
              <option value="4">Sem 4</option>
            </select>
          </div>
          <div class="col-md-3 col-12 mb-2">
            <label for="date" class="form-label">Date</label>
            <input type="date" id="date" class="form-control">
          </div>
          <div class="col-md-3 col-12 mb-2">
            <label for="hour" class="form-label">Hour</label>
            <select id="hour" class="form-select">
              <option value="9:30-10:30">Morning 1 (9:30-10:30)</option>
              <option value="10:30-11:30">Morning 2 (10:30-11:30)</option>
              <option value="11:30-12:30">Morning 3 (11:30-12:30)</option>
              <option value="1:30-2:30">Afternoon 1 (1:30-2:30)</option>
              <option value="2:30-3:30">Afternoon 2 (2:30-3:30)</option>
            </select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6 col-12 mb-2">
            <label for="startRoll" class="form-label">Start Roll (6 digits)</label>
            <input type="number" id="startRoll" class="form-control" placeholder="Start Roll">
          </div>
          <div class="col-md-6 col-12 mb-2">
            <label for="endRoll" class="form-label">End Roll (6 digits)</label>
            <input type="number" id="endRoll" class="form-control" placeholder="End Roll">
          </div>
        </div>
        <button id="generateListBtn" class="btn btn-primary">Generate Student List</button>
      </div>
    </div>
    
    <!-- Student Attendance List -->
    <div class="card mb-4">
      <div class="card-header">Attendance List</div>
      <div class="card-body">
        <div id="studentList" class="list-group">
          <!-- Dynamically generated student list -->
        </div>
        <button id="submitAttendanceBtn" class="btn btn-success mt-3">Submit Attendance</button>
      </div>
    </div>
    
    <!-- Attendance Report -->
    <div class="card mb-4">
      <div class="card-header">Attendance Report</div>
      <div class="card-body">
        <div id="reportContainer" class="border p-3">
          <!-- Report will be loaded here -->
        </div>
        <button id="refreshReportBtn" class="btn btn-secondary mt-3">Refresh Report</button>
      </div>
    </div>
    
    <!-- Fetch Individual Attendance Details Section -->
    <div class="card mb-4">
      <div class="card-header">Fetch Individual Attendance Details</div>
      <div class="card-body">
        <button id="fetchDetailsBtn" class="btn btn-info mb-3">Fetch individual attendance details</button>
        <div id="detailsForm" style="display:none;">
          <div class="mb-3">
            <label for="detailCourse" class="form-label">Course</label>
            <select id="detailCourse" class="form-select">
              <option value="MCA">MCA</option>
              <option value="MBA">MBA</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="detailSemester" class="form-label">Semester</label>
            <select id="detailSemester" class="form-select">
              <option value="1">Sem 1</option>
              <option value="2">Sem 2</option>
              <option value="3">Sem 3</option>
              <option value="4">Sem 4</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="detailDuration" class="form-label">Duration</label>
            <select id="detailDuration" class="form-select">
              <option value="single">Single Day</option>
              <option value="multiple">Multiple Days</option>
            </select>
          </div>
          <div id="singleDateDiv" class="mb-3">
            <label for="singleDate" class="form-label">Select Date</label>
            <input type="date" id="singleDate" class="form-control">
          </div>
          <div id="multipleDateDiv" class="mb-3" style="display:none;">
            <label class="form-label">Select Date Range</label>
            <div class="row">
              <div class="col">
                <input type="date" id="fromDate" class="form-control" placeholder="From Date">
              </div>
              <div class="col">
                <input type="date" id="toDate" class="form-control" placeholder="To Date">
              </div>
            </div>
          </div>
          <button id="fetchAttendanceDetailsBtn" class="btn btn-primary">Submit</button>
        </div>
        
        <!-- Table to display individual attendance details -->
        <div id="attendanceDetailsTableContainer" class="mt-4" style="display:none;">
          <h5>Individual Attendance Details</h5>
          <div class="table-responsive">
            <table id="attendanceDetailsTable" class="table table-bordered">
              <!-- Header and body will be populated dynamically -->
            </table>
          </div>
          <button id="exportDetailsToExcelBtn" class="btn btn-secondary mt-3">Export to Excel</button>
        </div>
        
      </div>
    </div>
    
  </div>

  <!-- Include Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- Include SheetJS for Excel export functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    /*************** Initialize Supabase Client ******************/
    const supabaseUrl = 'https://elxyhkfuuugjskallwsp.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVseHloa2Z1dXVnanNrYWxsd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4MjA5ODksImV4cCI6MjA1NDM5Njk4OX0.BAEvcCVIQiVdsg0m3xX72Xi0p-vnJ4WqfZU0mE_Tuk0';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    /*************** Global Variables ******************/
    let attendanceData = {};
    // Set default date to today for session attendance
    document.getElementById('date').value = new Date().toISOString().split('T')[0];

    /*************** Spinner Helper Functions ******************/
    function showSpinnerOnButton(button) {
      button.disabled = true;
      const spinner = document.createElement('span');
      spinner.className = "spinner-border spinner-border-sm ms-2";
      spinner.role = "status";
      spinner.ariaHidden = "true";
      button.appendChild(spinner);
    }
    
    function hideSpinnerOnButton(button) {
      button.disabled = false;
      const spinner = button.querySelector('.spinner-border');
      if (spinner) {
        spinner.remove();
      }
    }
    
    function showSpinnerInContainer(container) {
      container.innerHTML = `<div class="d-flex justify-content-center my-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>`;
    }
    
    /*************** Event Listeners ******************/
    document.getElementById('generateListBtn').addEventListener('click', generateStudentList);
    document.getElementById('submitAttendanceBtn').addEventListener('click', submitAttendance);
    document.getElementById('fetchDetailsBtn').addEventListener('click', () => {
      const formDiv = document.getElementById('detailsForm');
      formDiv.style.display = formDiv.style.display === 'none' ? 'block' : 'none';
    });
    document.getElementById('detailDuration').addEventListener('change', toggleDateInputs);
    document.getElementById('fetchAttendanceDetailsBtn').addEventListener('click', fetchAttendanceDetails);
    document.getElementById('exportDetailsToExcelBtn').addEventListener('click', exportDetailsToExcel);
    document.getElementById('refreshReportBtn').addEventListener('click', loadAttendanceReport);

    /*************** Functions for Session Attendance ******************/
    function generateStudentList() {
      const start = parseInt(document.getElementById('startRoll').value, 10);
      const end = parseInt(document.getElementById('endRoll').value, 10);
      const listContainer = document.getElementById('studentList');
      listContainer.innerHTML = ''; // Clear any previous list
      attendanceData = {}; // Reset the attendance data

      if (isNaN(start) || isNaN(end) || start > end) {
        alert("Please enter valid roll numbers.");
        return;
      }

      for (let i = start; i <= end; i++) {
        const rollNo = i.toString().padStart(6, '0');
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-group-item student-item';
        itemDiv.innerHTML = `
          <span>${rollNo}</span>
          <button class="status-btn present" data-roll="${rollNo}">Present</button>
        `;
        listContainer.appendChild(itemDiv);
        attendanceData[rollNo] = true; // Default: present
      }

      // Attach toggle listeners
      document.querySelectorAll('.status-btn').forEach(button => {
        button.addEventListener('click', () => {
          toggleStatus(button, button.getAttribute('data-roll'));
        });
      });
    }

    function toggleStatus(button, rollNo) {
      const isPresent = attendanceData[rollNo];
      attendanceData[rollNo] = !isPresent;
      if (isPresent) {
        button.classList.remove('present');
        button.classList.add('absent');
        button.textContent = 'Absent';
      } else {
        button.classList.remove('absent');
        button.classList.add('present');
        button.textContent = 'Present';
      }
    }

    async function submitAttendance() {
      const submitBtn = document.getElementById('submitAttendanceBtn');
      showSpinnerOnButton(submitBtn);
      
      const course = document.getElementById('course').value;
      const semester = parseInt(document.getElementById('semester').value, 10);
      const date = document.getElementById('date').value;
      const hour = document.getElementById('hour').value;

      if (!date || !hour) {
        alert("Please fill in all required fields.");
        hideSpinnerOnButton(submitBtn);
        return;
      }

      // Backup local attendance data
      const backupKey = `${course}_${semester}_${date}_${hour}`;
      localStorage.setItem(backupKey, JSON.stringify(attendanceData));

      // Prepare record for upsert
      const record = { course, semester, date, hour, data: attendanceData };

      // Check if a record for this session already exists
      const { data: existingRecord, error: fetchError } = await supabaseClient
        .from('attendance')
        .select('*')
        .eq('course', course)
        .eq('semester', semester)
        .eq('date', date)
        .eq('hour', hour)
        .single();

      if (fetchError && fetchError.code !== 'PGRST116') {
        console.error("Error checking existing record:", fetchError);
        alert("Error checking existing data.");
        hideSpinnerOnButton(submitBtn);
        return;
      }

      if (existingRecord) {
        if (!confirm("An attendance record for this session already exists. Do you want to delete the existing data and overwrite it?")) {
          hideSpinnerOnButton(submitBtn);
          return;
        }
        const { error: deleteError } = await supabaseClient
          .from('attendance')
          .delete()
          .eq('course', course)
          .eq('semester', semester)
          .eq('date', date)
          .eq('hour', hour);
        if (deleteError) {
          console.error("Error deleting existing record:", deleteError);
          alert("Error deleting existing record.");
          hideSpinnerOnButton(submitBtn);
          return;
        }
      }

      try {
        const { error } = await supabaseClient
          .from('attendance')
          .insert(record, { returning: 'minimal' });
        if (error) {
          console.error("Error saving attendance:", error);
          alert("Error saving attendance data.");
        } else {
          const absentCount = Object.values(attendanceData).filter(status => !status).length;
          alert(`Attendance submitted successfully! Absent students: ${absentCount}`);
          loadAttendanceReport();
        }
      } catch (err) {
        console.error("Unexpected error:", err);
        alert("Unexpected error occurred during submission.");
      } finally {
        hideSpinnerOnButton(submitBtn);
      }
    }

    /*************** Functions for Individual Attendance Details ******************/
    function toggleDateInputs() {
      const duration = document.getElementById('detailDuration').value;
      if (duration === 'single') {
        document.getElementById('singleDateDiv').style.display = 'block';
        document.getElementById('multipleDateDiv').style.display = 'none';
      } else {
        document.getElementById('singleDateDiv').style.display = 'none';
        document.getElementById('multipleDateDiv').style.display = 'block';
      }
    }

    async function fetchAttendanceDetails() {
  const fetchBtn = document.getElementById('fetchAttendanceDetailsBtn');
  showSpinnerOnButton(fetchBtn);
  const course = document.getElementById('detailCourse').value;
  const semester = parseInt(document.getElementById('detailSemester').value, 10);
  const duration = document.getElementById('detailDuration').value;
  let fromDate, toDate;

  if (duration === 'single') {
    fromDate = toDate = document.getElementById('singleDate').value;
    if (!fromDate) {
      alert("Please select a date.");
      hideSpinnerOnButton(fetchBtn);
      return;
    }
  } else {
    fromDate = document.getElementById('fromDate').value;
    toDate = document.getElementById('toDate').value;
    if (!fromDate || !toDate) {
      alert("Please select both from and to dates.");
      hideSpinnerOnButton(fetchBtn);
      return;
    }
  }

  try {
    const { data, error } = await supabaseClient
      .from('attendance')
      .select('*')
      .eq('course', course)
      .eq('semester', semester)
      .gte('date', fromDate)
      .lte('date', toDate);

    if (error) {
      console.error("Error fetching attendance details:", error);
      alert("Error fetching data.");
      hideSpinnerOnButton(fetchBtn);
      return;
    }
    if (data.length === 0) {
      alert("No attendance records found for the selected criteria.");
      hideSpinnerOnButton(fetchBtn);
      return;
    }

    const morningHours = ["9:30-10:30", "10:30-11:30", "11:30-12:30"];
    const afternoonHours = ["1:30-2:30", "2:30-3:30"];

    const dailyAttendance = {};
    const allRollNumbers = new Set();

    data.forEach(session => {
      const date = session.date;
      if (!dailyAttendance[date]) dailyAttendance[date] = {};
      for (const roll in session.data) {
        allRollNumbers.add(roll);
        if (!dailyAttendance[date][roll]) {
          dailyAttendance[date][roll] = { morning: {}, afternoon: {} };
        }
        if (morningHours.includes(session.hour)) {
          dailyAttendance[date][roll].morning[session.hour] = session.data[roll];
        } else if (afternoonHours.includes(session.hour)) {
          dailyAttendance[date][roll].afternoon[session.hour] = session.data[roll];
        }
      }
    });

    const dateColumns = Object.keys(dailyAttendance).sort();

    // Create a caption with course, semester, and time span
    let captionText = "";
    if (duration === "single") {
      captionText = `${course} - Semester ${semester} on ${fromDate}`;
    } else {
      captionText = `${course} - Semester ${semester} from ${fromDate} to ${toDate}`;
    }

    let tableHTML = `<caption class="text-center fw-bold fs-5 mb-3">${captionText}</caption>`;
    tableHTML += '<thead class="table-light"><tr><th>Roll Number</th>';
    dateColumns.forEach(date => { tableHTML += `<th>${date}</th>`; });
    tableHTML += '<th>Total Attendance</th><th>Percentage</th></tr></thead><tbody>';

    allRollNumbers.forEach(roll => {
      let studentTotal = 0;
      tableHTML += `<tr><td>${roll}</td>`;
      dateColumns.forEach(date => {
        let dayScore = 0;
        const studentDay = dailyAttendance[date][roll];
        let statusArr = [];

        // Build statuses for morning hours (3 hours)
        morningHours.forEach(hour => {
          let status = "a";
          if (studentDay && (hour in studentDay.morning)) {
            status = studentDay.morning[hour] === true ? "p" : "a";
          }
          statusArr.push(status);
        });
        // Build statuses for afternoon hours (2 hours)
        afternoonHours.forEach(hour => {
          let status = "a";
          if (studentDay && (hour in studentDay.afternoon)) {
            status = studentDay.afternoon[hour] === true ? "p" : "a";
          }
          statusArr.push(status);
        });

        // Calculate day score based on complete blocks:
        // If all 3 morning hours are present then add 0.5; similarly for the 2 afternoon hours.
        if (studentDay) {
          if (Object.keys(studentDay.morning).length === morningHours.length) {
            const fullMorning = morningHours.every(hour => studentDay.morning[hour] === true);
            dayScore += fullMorning ? 0.5 : 0;
          }
          if (Object.keys(studentDay.afternoon).length === afternoonHours.length) {
            const fullAfternoon = afternoonHours.every(hour => studentDay.afternoon[hour] === true);
            dayScore += fullAfternoon ? 0.5 : 0;
          }
        }
        studentTotal += dayScore;
        tableHTML += `<td>${dayScore} (${statusArr.join(", ")})</td>`;
      });
      const totalDays = dateColumns.length;
      const percentage = totalDays > 0 ? ((studentTotal / totalDays) * 100).toFixed(2) : '0';
      tableHTML += `<td>${studentTotal}</td><td>${percentage}%</td></tr>`;
    });
    tableHTML += '</tbody>';

    document.getElementById('attendanceDetailsTable').innerHTML = tableHTML;
    document.getElementById('attendanceDetailsTableContainer').style.display = 'block';
  } catch (err) {
    console.error("Error processing attendance details:", err);
    alert("Error processing data.");
  } finally {
    hideSpinnerOnButton(fetchBtn);
  }
}

function exportDetailsToExcel() {
  const table = document.getElementById('attendanceDetailsTable');
  const worksheet = XLSX.utils.table_to_sheet(table);
  const workbook = XLSX.utils.book_new();

  const course = document.getElementById('detailCourse').value;
  const sem = document.getElementById('detailSemester').value;

  let fileName = `Individual_Attendance_${course}_Sem${sem}`;
  const duration = document.getElementById('detailDuration').value;

  if (duration === 'single') {
    const singleDate = document.getElementById('singleDate').value;
    fileName += `_${singleDate}`;
  } else {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    fileName += `_${fromDate}_to_${toDate}`;
  }

  fileName += ".xlsx";

  XLSX.utils.book_append_sheet(workbook, worksheet, "IndividualAttendance");
  XLSX.writeFile(workbook, fileName);
}


    /*************** Attendance Report Functions ******************/
    const hours = [
      "9:30-10:30",
      "10:30-11:30",
      "11:30-12:30",
      "1:30-2:30",
      "2:30-3:30"
    ];

    async function loadAttendanceReport() {
      const course = document.getElementById('course').value;
      const semester = parseInt(document.getElementById('semester').value, 10);
      const dateInput = document.getElementById('date').value;
      const today = dateInput ? dateInput : new Date().toISOString().split('T')[0];
      const reportContainer = document.getElementById('reportContainer');
      
      // Show spinner in the report container
      showSpinnerInContainer(reportContainer);

      let reportHTML = `<h3>${course} - Semester ${semester} (Date: ${today})</h3>`;
      reportHTML += `<div class="d-flex flex-wrap">`;

      for (const hour of hours) {
        const { data } = await supabaseClient
          .from('attendance')
          .select('*')
          .eq('course', course)
          .eq('semester', semester)
          .eq('date', today)
          .eq('hour', hour)
          .maybeSingle();

        const status = data ? "Recorded" : "Missing";
        const statusClass = data ? "status-green" : "status-red";
        reportHTML += `<div class="status-box ${statusClass}">${hour}<br>${status}</div>`;
      }
      reportHTML += `</div>`;
      reportContainer.innerHTML = reportHTML;
    }

    // Load the report when the page loads
    loadAttendanceReport();
  </script>
</body>
</html>
